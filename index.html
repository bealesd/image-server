<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beales Images</title>
    <link rel="stylesheet" href="./assets/styles/style.css">
</head>

<body>
    <div class="menu-bar">
        <button class="green-button" id='photos'>Photos</button>
        <button class="green-button" id='directory'>Directory</button>
        <button class="green-button" id='albums'>Albums</button>
        <button class="green-button" id='albums'>Slideshow</button>
    </div>

    <div id="pageContainer">

        <div id="photoControls" class="hidden">
            <h1 id="pageNumber"></h1>
            <button class="green-button" id="back">Back</button>
            <button class="green-button" id="next">Next</button>
        </div>

        <div id="container">

        </div>

    </div>

    <script type="module">
        // slideshow - link to slideshow to show one photo, then change to new photo every 10 seconds
        // albums search with images
        // directory -  up level link
        import { Config } from '/config.js';

        let ipAddress = new Config().ipAddress;
        ipAddress = 'localhost';
        const port = new Config().port;
        const baseUrl = `http://${ipAddress}:${port}`;

        const pageIncrement = 3;
        let start = 0;

        const backButton = document.querySelector('#back');
        const nextButton = document.querySelector('#next');
        const directoryButton = document.querySelector('#directory');
        const photosButton = document.querySelector('#photos');
        const photoControls = document.querySelector('#photoControls')

        function changePage(option) {
            if (option.forward)
                start += pageIncrement;
            else
                start -= pageIncrement;
        }

        function printPage() {
            document.querySelector('#pageNumber').innerHTML = `Page: ${Math.floor(start / pageIncrement)}`;
        }

        async function getImages() {
            let req = await fetch(`${baseUrl}/images?start=${start}&number=3`);
            let images = await req.json();
            let content = '';

            Object.keys(images).forEach((img) => {
                const image = images[img];
                let imageDiv = `<div class="responsive">
                    <div class="gallery">
                        <a target="" href="image?id=${img}">
                            <img src="image?id=${img}" alt="${image.mageName}" width="600" height="400">
                        </a>
                        <div class="desc">${image.day}/${image.month}/${image.year}</div>
                    </div>
                </div>`;
                content += imageDiv;
            })


            document.querySelector('#container').innerHTML = content;
        }

        photosButton.addEventListener('click', async () => {
            printPage();
            photoControls.classList.remove('hidden');
            await getImages();

        });

        backButton.addEventListener('click', async () => {
            changePage({
                forward: false
            });
            printPage();
            await getImages();
        });

        nextButton.addEventListener('click', async () => {
            changePage({
                forward: true
            });
            printPage();
            await getImages();
        });

        directoryButton.addEventListener('click', async () => {
            getDirectories('images');
        });

        document.querySelector('#container').addEventListener('click', async function (e) {
            const element = e.target;
            if (e.target.dataset.hasOwnProperty('id') && e.target.classList.contains(`folder`)) {
                await getDirectories(element.dataset.id);
            }
        });

        async function getDirectories(path) {
            photoControls.classList.add('hidden');
            const url = `${baseUrl}/listDirectory?dir=${path}`;
            let request = await fetch(url);

            let directories = await request.json();
            document.querySelector('#container').innerHTML = '';

            let content = '';

            // show current directory
            const currentDirectory = `<div class="image-link"><h2>${path}</h2></div>`;
            content += currentDirectory;

            // add up level link
            const upDirectory = path.split('/').slice(0, -1).join('/');
            if (upDirectory !== '') {
                const href = `${baseUrl}/listDirectory?dir=${upDirectory}`;
                const dirDiv = `<div class="image-link"><span class="icon-undo2"></span><a class="folder green" data-id='${upDirectory}'>${upDirectory}</a></div>`;
                content += dirDiv;
            }

            let directoryList = Object.keys(directories).map(dir => {
                const directory = directories[dir];
                return {
                    id: dir,
                    isFile: directory.isFile,
                    name: directory.name
                }

            });
            console.log(directoryList);

            // content of directory
            directoryList.filter(dir => dir.isFile !== true).sort(sortAlphabetically).forEach((dir) => {
                const fileName = dir.id.split('/').slice(-1);
                const href = `${baseUrl}/listDirectory?dir=${dir.id}`;
                const dirDiv = `<div class="image-link"><span class="icon-folder"></span><a class="folder green" data-id='${dir.id}'>${fileName}</a></div>`;
                content += dirDiv;
            })

            directoryList.filter(dir => dir.isFile === true).sort(sortAlphabetically).forEach((dir) => {
                const fileName = dir.id.split('/').slice(-1);
                const href = `${baseUrl}/image?id=${dir.id}`;
                const dirDiv = `<div class="image-link"><span class="icon-file-picture"></span><a class="green" target="_blank" href="${href}">${fileName}</a></div>`;
                content += dirDiv;
            })

            document.querySelector('#container').innerHTML = content;
        }

        function sortAlphabetically(a, b) {
            if (a.name.toLowerCase() < b.name.toLowerCase()) return -1;
            if (a.name.toLowerCase() > b.name.toLowerCase()) return 1;
            return 0;
        }

    </script>
</body>

</html>