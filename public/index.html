<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beales Images</title>
    <link rel="stylesheet" href="./assets/styles/style.css">
</head>

<body>
    <div class="menu-bar">
        <button class="green-button" id='photos'>Photos</button>
        <button class="green-button" id='directory'>Directory</button>
        <button class="green-button" id='albums'>Albums</button>
        <button class="green-button" id='slideshow'>Slideshow</button>
    </div>

    <div id="pageContainer">

        <div id="photoControls" class="hidden">
            <h1 id="pageNumber"></h1>
            <button class="green-button" id="back">Back</button>
            <button class="green-button" id="next">Next</button>
        </div>

        <div id="container">
        </div>

    </div>

    <script type="module">
        // import { Config } from './assets/js/config.js';

        // let ipAddress = new Config().ipAddress;
        // ipAddress = 'localhost';
        // const port = new Config().port;
        // const baseUrl = `http://${ipAddress}:${port}`;

        const photosPerPage = 10;
        let photosCurrentPage = 1;
        let slideshowImageIndex = 0;
        const slideShowInterval = 10000;

        const backButton = document.querySelector('#back');
        const nextButton = document.querySelector('#next');
        const directoryButton = document.querySelector('#directory');
        const photosButton = document.querySelector('#photos');
        const albumsButton = document.querySelector('#albums');
        const slideshowButton = document.querySelector('#slideshow');

        const photoControls = document.querySelector('#photoControls')
        let isLastPage = false;

        function updatePageNumber(option) {
            if (option.direction === 'next') {
                photosCurrentPage++;
            }
            else if (option.direction === 'back') {
                photosCurrentPage--;
            }
        }

        function printPageNumber() {
            document.querySelector('#pageNumber').innerHTML = `Page: ${photosCurrentPage}`;
        }

        async function getImage() {
            let req = await fetch(`./images?startIndex=${slideshowImageIndex}&endIndex=${slideshowImageIndex + 1}`);
            let images = await req.json();
            let content = '';

            if (images.length === 0) {
                slideshowImageIndex = 0;
                content += `<h1>Slideshow has finished!</h1>`;
            }

            images.forEach((img) => {
                let imageDiv = `<div class="slideshow">
                                 <img src="image?id=${img.id}" alt="${img.name}" title="${img.name}">
                            </div>`;
                content += imageDiv;
            })

            document.querySelector('#container').innerHTML = content;
        }

        async function getImages(startIndex, endIndex) {
            let req = await fetch(`./images?startIndex=${startIndex}&endIndex=${endIndex}`);
            let images = await req.json();
            return images;
        }

        function drawImages(images) {
            let content = '';
            images.forEach((img) => {
                let imageDiv = `
                <div class="responsive" onclick="window.open('image?id=${img.id}')">
                    <div class="gallery">
                        <img align="middle" src="image?id=${img.id}" alt="${img.name}" title="${img.day}/${img.month}/${img.year}">
                    </div>
                    <div class="desc">${img.name}</div>
                </div>
                `;
                content += imageDiv;
            })
            document.querySelector('#container').innerHTML = content;
        }

        albumsButton.addEventListener('click', async () => {
            await getDirectories('images', true)

        });

        slideshowButton.addEventListener('click', async () => {
            await getImage();
            slideshowImageIndex++;
            window.interval = setInterval(async () => {
                await getImage();
                slideshowImageIndex++;
            }, slideShowInterval)
        });

        photosButton.addEventListener('click', async () => {
            printPageNumber();

            let result = await getImages(getPhotosStartIndex(), getPhotosEndIndex());
            drawImages(result);

            updatePhotoControls(result);
        });


        backButton.addEventListener('click', async () => {
            updatePageNumber({ direction: 'back' });
            printPageNumber()

            let result = await getImages(getPhotosStartIndex(), getPhotosEndIndex());
            drawImages(result);

            updatePhotoControls(result);
        });

        nextButton.addEventListener('click', async () => {
            updatePageNumber({ direction: 'next' });
            printPageNumber()

            let result = await getImages(getPhotosStartIndex(), getPhotosEndIndex());
            drawImages(result);

            updatePhotoControls(result);
        });

        function getPhotosStartIndex() {
            if (photosCurrentPage === 1) {
                return 0;
            }
            else {
                return (photosCurrentPage - 1) * photosPerPage;
            }
        }

        function getPhotosEndIndex() {
            return getPhotosStartIndex() + photosPerPage;
        }

        function updatePhotoControls(images) {
            updateBackPage();
            updateNextPage(images);
        }

        function updateBackPage() {
            if (photosCurrentPage === 1) {
                backButton.disabled = true;
            }
            else if (photosCurrentPage > 1) {
                backButton.disabled = false;
            }
        }

        function updateNextPage(images) {
            if (images.length === 0 || images.slice(-1)[0].isLastImage) {
                nextButton.disabled = true;
            }
            else {
                nextButton.disabled = false;
            }
        }

        directoryButton.addEventListener('click', async () => {
            getDirectories('images');
        });

        document.querySelector('#container').addEventListener('click', async function (e) {
            const element = e.target;
            if (element.dataset.hasOwnProperty('id') && element.classList.contains(`folder`)) {
                const showImages = element.classList.contains('showImages');
                if (showImages) {
                    await getDirectories(element.dataset.id, true);
                }
                else {
                    await getDirectories(element.dataset.id);
                }
            }
        });

        document.querySelector('.menu-bar').addEventListener('click', async function (e) {
            // destructor - call each components destructor in future
            photoControls.classList.add('hidden');

            clearInterval(window.interval);

            const element = e.target;
            if (element === photosButton) {
                photoControls.classList.remove('hidden');
            }


        });

        async function getDirectories(path, images = false) {
            const url = `./listDirectory?dir=${path}`;
            let request = await fetch(url);

            let directories = await request.json();
            document.querySelector('#container').innerHTML = '';

            let content = '';

            // show current directory
            const currentDirectory = `<div class="image-link"><h2>${path}</h2></div>`;
            content += currentDirectory;

            // add up level link
            const upDirectory = path.split('/').slice(0, -1).join('/');
            if (upDirectory !== '') {
                const href = `./listDirectory?dir=${upDirectory}`;
                const dirDiv = `<div class="image-link"><span class="icon-undo2"></span><a class="folder green ${images ? 'showImages' : ''}" data-id='${upDirectory}'>${upDirectory}</a></div>`;
                content += dirDiv;
            }

            directories.filter(dir => dir.isFile !== true).sort(sortAlphabetically).forEach((dir) => {
                const href = `./listDirectory?dir=${dir.id}`;
                const dirDiv = `<div class="image-link"><span class="icon-folder"></span><a class="folder green ${images ? 'showImages' : ''}" data-id='${dir.id}'>${dir.name}</a></div>`;
                content += dirDiv;
            })

            directories.filter(dir => dir.isFile === true).sort(sortAlphabetically).forEach((dir) => {
                const href = `./image?id=${dir.id}`;
                let dirDiv = '';
                if (images) {
                    dirDiv = `
                        <div class="responsive" onclick="window.open('image?id=${dir.id}')">
                            <div class="gallery">
                                <img align="middle" src="image?id=${dir.id}" alt="${dir.name}" title="${dir.day}/${dir.month}/${dir.year}">
                            </div>
                            <div class="desc">${dir.name}</div>
                        </div>
                `
                }
                else {
                    dirDiv = `<div class="image-link"><span class="icon-file-picture"></span><a class="green" target="_blank" href="${href}">${dir.name}</a></div>`;
                }
                content += dirDiv;
            })

            document.querySelector('#container').innerHTML = content;
        }

        function sortAlphabetically(a, b) {
            if (a.name.toLowerCase() < b.name.toLowerCase()) return -1;
            if (a.name.toLowerCase() > b.name.toLowerCase()) return 1;
            return 0;
        }

    </script>
</body>

</html>