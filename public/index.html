<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beales Images</title>
    <link rel="stylesheet" href="./assets/styles/style.css">
</head>

<body>
    <div class="menu-bar">
        <button class="green-button" id='photos'>Photos</button>
        <button class="green-button" id='directory'>Directory</button>
        <button class="green-button" id='albums'>Albums</button>
        <button class="green-button" id='slideshow'>Slideshow</button>
    </div>

    <div id="pageContainer">

        <div id="photoControls" class="hidden">
            <h1 id="pageNumber"></h1>
            <button class="green-button" id="back">Back</button>
            <button class="green-button" id="next">Next</button>
        </div>

        <div id="container">
        </div>

    </div>

    <script type="module">
        // import { Config } from './assets/js/config.js';

        // let ipAddress = new Config().ipAddress;
        // ipAddress = 'localhost';
        // const port = new Config().port;
        // const baseUrl = `http://${ipAddress}:${port}`;

        const photosPerPage = 3;
        let photosStartIndex = 1;
        let photosCurrentPage = 1;
        let slideshowImageIndex = 0;

        const backButton = document.querySelector('#back');
        const nextButton = document.querySelector('#next');
        const directoryButton = document.querySelector('#directory');
        const photosButton = document.querySelector('#photos');
        const albumsButton = document.querySelector('#albums');
        const slideshowButton = document.querySelector('#slideshow');

        const photoControls = document.querySelector('#photoControls')
        let isLastPage = false;

        function updatePageNumber(option) {
            if (option.direction === 'next') {
                photosCurrentPage++;
            }
            else if (option.direction === 'back') {
                photosCurrentPage--;
            }
        }

        function printPageNumber() {
            document.querySelector('#pageNumber').innerHTML = `Page: ${photosCurrentPage}`;
        }

        async function getImage() {
            let req = await fetch(`./images?startIndex=${slideshowImageIndex}&endIndex=${slideshowImageIndex + 1}`);
            let images = await req.json();
            let content = '';

            if (images.length === 0) {
                slideshowImageIndex = 0;
                content += `<h1>Slideshow has finished!</h1>`;
            }

            images.forEach((img) => {
                let imageDiv = `<div class="slideshow">
                                 <img src="image?id=${img.id}" alt="${img.name}" title="${img.name}">
                            </div>`;
                content += imageDiv;
            })

            document.querySelector('#container').innerHTML = content;
        }

        async function getImages(startIndex, endIndex) {
            // change to an array being returned
            let req = await fetch(`./images?startIndex=${startIndex}&endIndex=${endIndex}`);
            let images = await req.json();
            return images;
        }

        function drawImages(images) {
            let content = '';
            images.forEach((img) => {
                let imageDiv = `<div class="responsive">
                    <div class="gallery">
                        <a target="" href="image?id=${img.id}">
                            <img src="image?id=${img.id}" alt="${img.name}" title="${img.day}/${img.month}/${img.year}" height="400">
                        </a>
                        <div class="desc">${img.name}</div>
                    </div>
                </div>`;
                content += imageDiv;
            })
            // width="600"

            document.querySelector('#container').innerHTML = content;
        }

        albumsButton.addEventListener('click', async () => {
            photoControls.classList.add('hidden');
            clearInterval(window.interval);
            await getDirectories('images', true)

        });

        slideshowButton.addEventListener('click', async () => {
            photoControls.classList.add('hidden');
            clearInterval(window.interval);
            await getImage();
            slideshowImageIndex++;
            window.interval = setInterval(async () => {
                await getImage();
                slideshowImageIndex++;
            }, 10000)
        });

        photosButton.addEventListener('click', async () => {
            clearInterval(window.interval);
            photoControls.classList.remove('hidden');

            printPageNumber();

            let result = await getImages(getPhotosStartIndex(), getPhotosEndIndex());
            drawImages(result);

            updatePhotoControls(result);
        });


        backButton.addEventListener('click', async () => {
            updatePageNumber({ direction: 'back' });
            printPageNumber()

            let result = await getImages(getPhotosStartIndex(), getPhotosEndIndex());
            drawImages(result);

            updatePhotoControls(result);
        });

        nextButton.addEventListener('click', async () => {
            updatePageNumber({ direction: 'next' });
            printPageNumber()

            let result = await getImages(getPhotosStartIndex(), getPhotosEndIndex());
            drawImages(result);

            updatePhotoControls(result);
        });

        function getPhotosStartIndex() {
            if (photosCurrentPage === 1) {
                return 0;
            }
            else {
                return (photosCurrentPage - 1) * photosPerPage;
            }
        }

        function getPhotosEndIndex() {
            return getPhotosStartIndex() + photosPerPage;
        }

        function updatePhotoControls(images) {
            updateBackPage();
            updateNextPage(images);
        }

        function updateBackPage() {
            if (photosCurrentPage === 1) {
                backButton.disabled = true;
            }
            else if (photosCurrentPage > 1) {
                backButton.disabled = false;
            }
        }

        function updateNextPage(images) {
            if (images.length === 0 || images.slice(-1)[0].isLastImage) {
                nextButton.disabled = true;
            }
            else {
                nextButton.disabled = false;
            }
        }

        directoryButton.addEventListener('click', async () => {
            clearInterval(window.interval);
            getDirectories('images');
        });

        window.i = 0;
        document.querySelector('#container').addEventListener('click', async function (e) {
            console.log(window.i++);
            const element = e.target;
            if (e.target.dataset.hasOwnProperty('id') && e.target.classList.contains(`folder`)) {
                const showImages = e.target.classList.contains('showImages');
                if (showImages) {
                    await getDirectories(element.dataset.id, true);
                }
                else {
                    await getDirectories(element.dataset.id);
                }
            }
        });

        async function getDirectories(path, images = false) {
            const url = `./listDirectory?dir=${path}`;
            let request = await fetch(url);

            let directories = await request.json();
            document.querySelector('#container').innerHTML = '';

            let content = '';

            // show current directory
            const currentDirectory = `<div class="image-link"><h2>${path}</h2></div>`;
            content += currentDirectory;

            // add up level link
            const upDirectory = path.split('/').slice(0, -1).join('/');
            if (upDirectory !== '') {
                const href = `./listDirectory?dir=${upDirectory}`;
                const dirDiv = `<div class="image-link"><span class="icon-undo2"></span><a class="folder green ${images ? 'showImages' : ''}" data-id='${upDirectory}'>${upDirectory}</a></div>`;
                content += dirDiv;
            }

            let directoryList = Object.keys(directories).map(dir => {
                const directory = directories[dir];
                return {
                    id: dir,
                    isFile: directory.isFile,
                    name: directory.name
                }
            });

            // content of directory
            directoryList.filter(dir => dir.isFile !== true).sort(sortAlphabetically).forEach((dir) => {
                const fileName = dir.id.split('/').slice(-1);
                const href = `./listDirectory?dir=${dir.id}`;
                const dirDiv = `<div class="image-link"><span class="icon-folder"></span><a class="folder green ${images ? 'showImages' : ''}" data-id='${dir.id}'>${fileName}</a></div>`;
                content += dirDiv;
            })

            directoryList.filter(dir => dir.isFile === true).sort(sortAlphabetically).forEach((dir) => {
                const fileName = dir.id.split('/').slice(-1);
                const href = `./image?id=${dir.id}`;
                let dirDiv = '';
                if (images) {
                    dirDiv = `<div class="responsive">
                    <div class="gallery">
                        <a target="" href="${href}">
                            <img src="${href}" alt="${''}"  height="400">
                        </a>
                        <div class="desc">${fileName}</div>
                    </div>
                </div>`
                }
                else {
                    dirDiv = `<div class="image-link"><span class="icon-file-picture"></span><a class="green" target="_blank" href="${href}">${fileName}</a></div>`;
                }
                content += dirDiv;
            })

            document.querySelector('#container').innerHTML = content;
        }

        function sortAlphabetically(a, b) {
            if (a.name.toLowerCase() < b.name.toLowerCase()) return -1;
            if (a.name.toLowerCase() > b.name.toLowerCase()) return 1;
            return 0;
        }

    </script>
</body>

</html>